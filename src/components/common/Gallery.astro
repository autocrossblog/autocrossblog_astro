---
import fs from 'fs';
import path from 'path';
import exifParser from 'exif-parser';
import PhotoSwipeInit from './PhotoSwipeInit.astro';
import { getImage } from 'astro:assets';
import 'photoswipe/dist/photoswipe.css';

// Props
const { galleryPath } = Astro.props;

if (!galleryPath) {
  return null;
}

// Resolve directory path
const imagesDirectory = path.resolve('.' + galleryPath);
const importedImages = import.meta.glob('/src/assets/images/**/*.{jpg,jpeg,png,webp}', { eager: true });

let imagesWithMetadata = [];
try {
  const imageFiles = fs
    .readdirSync(imagesDirectory)
    .filter((file) => /\.(jpg|jpeg|png|webp)$/i.test(file));

  // Generate multiple sizes for each image
  imagesWithMetadata = await Promise.all(
    imageFiles.map(async (file) => {
      const imagePath = `${galleryPath}/${file}`;
      const importedImage = importedImages[imagePath];

      if (!importedImage) {
        console.error(`Failed to import image: ${imagePath}`);
        return null;
      }

      const buffer = fs.readFileSync(path.resolve('.' + imagePath));
      const exif = exifParser.create(buffer).parse();

      // Generate thumbnail and full-sized images
      const thumbnail = await getImage({ src: imagePath, width: 300, height: 200 });
      const thumbnailSrcSet = `${thumbnail.src}?w=150&h=100 150w, ${thumbnail.src}?w=300&h=200 300w, ${thumbnail.src}?w=600&h=400 600w`;

      const fullImage = await getImage({ src: imagePath, width: 1280, height: 960 });
      const fullSrcSet = `${fullImage.src}?w=640&h=480 640w, ${fullImage.src}?w=1280&h=960 1280w, ${fullImage.src}?w=1920&h=1440 1920w`;

      return {
        thumbnail: {
          src: thumbnail.src,
          srcset: thumbnailSrcSet,
          width: thumbnail.width,
          height: thumbnail.height,
        },
        fullImage: {
          src: fullImage.src,
          srcset: fullSrcSet,
          width: fullImage.width,
          height: fullImage.height,
        },
        alt: exif.tags.ImageDescription || `Image ${file}`,
      };
    })
  );
} catch (err) {
  console.error(`Error reading directory: ${imagesDirectory}`, err);
}

---

<div class="gallery">
  {imagesWithMetadata.length > 0 ? (
    imagesWithMetadata.map((image, index) => (
      <div class="gallery-item" key={index}>
        <a
          href={image.fullImage.src}
          data-pswp-width={image.fullImage.width}
          data-pswp-height={image.fullImage.height}
          data-index={index}
        >
          <img
            src={image.thumbnail.src}
            srcset={image.thumbnail.srcset}
            sizes="(max-width: 768px) 90vw, (max-width: 1200px) 50vw, 30vw"
            alt={image.alt}
            width={image.thumbnail.width}
            height={image.thumbnail.height}
            style={{ maxWidth: '100%', objectFit: 'cover' }}
            loading="lazy"
          />
        </a>
        <p class="gallery-caption">{image.alt}</p>
      </div>
    ))
  ) : (
    <p>No images available for the gallery.</p>
  )}
</div>

<!-- PhotoSwipe Root -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="pswp__bg"></div>
  <div class="pswp__scroll-wrap">
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    <div class="pswp__ui pswp__ui--hidden">
      <div class="pswp__top-bar">
        <button type="button" class="pswp__button pswp__button--close" aria-label="Close"></button>
        <button type="button" class="pswp__button pswp__button--zoom" aria-label="Zoom"></button>
        <div class="pswp__counter"></div>
      </div>
    </div>
  </div>
</div>

<PhotoSwipeInit />
