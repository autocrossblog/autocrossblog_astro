---
import fs from 'fs';
import path from 'path';
import exifParser from 'exif-parser';
import PhotoSwipeInit from './PhotoSwipeInit.astro';
import 'photoswipe/dist/photoswipe.css';

// Props
const { galleryPath } = Astro.props;

if (!galleryPath) {
  return null;
}

const imagesDirectory = path.resolve('.' + galleryPath);
const importedImages = import.meta.glob('/src/assets/images/**/*.{jpg,jpeg,png,webp}', { eager: true });

let imagesWithMetadata = [];
try {
  const imageFiles = fs
    .readdirSync(imagesDirectory)
    .filter((file) => /\.(jpg|jpeg|png|webp)$/i.test(file));

  imagesWithMetadata = imageFiles.map((file) => {
    const imagePath = `${galleryPath}/${file}`;
    const importedImage = importedImages[imagePath];

    if (!importedImage) {
      console.error(`Failed to import image: ${imagePath}`);
      return null;
    }

    const buffer = fs.readFileSync(path.resolve('.' + imagePath));
    const exif = exifParser.create(buffer).parse();

    return {
      src: importedImage.default.src, // Access the correct `src`
      width: importedImage.default.width, // Access the correct `width`
      height: importedImage.default.height, // Access the correct `height`
      alt: exif.tags.ImageDescription || `Image ${file}`,
    };
  }).filter(Boolean);
} catch (err) {
  console.error(`Error reading directory: ${imagesDirectory}`, err);
}

//console.log(imagesWithMetadata);
---

<div class="gallery">
  {imagesWithMetadata.length > 0 ? (
    imagesWithMetadata.map((image, index) => (
      <div class="gallery-item" key={index}>
        <a
          href={image.src}
          data-pswp-width={image.width}
          data-pswp-height={image.height}
          data-index={index}
        >
          <img
            src={image.src}
            alt={image.alt}
            width={image.width}
            height={image.height}
            srcset={`${image.src}?w=320&h=240 320w, ${image.src}?w=640&h=480 640w, ${image.src}?w=1280&h=960 1280w`}
            sizes="(max-width: 768px) 90vw, (max-width: 1200px) 50vw, 30vw"
            style={{ maxWidth: '100%', objectFit: 'contain' }}
            loading="lazy"
          />
        </a>
        <p class="gallery-caption">{image.alt}</p>
      </div>
    ))
  ) : (
    <p>No images available for the gallery.</p>
  )}
</div>

<!-- PhotoSwipe Root -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="pswp__bg"></div>
  <div class="pswp__scroll-wrap">
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    <div class="pswp__ui pswp__ui--hidden">
      <div class="pswp__top-bar">
        <button type="button" class="pswp__button pswp__button--close" aria-label="Close"></button>
        <button type="button" class="pswp__button pswp__button--zoom" aria-label="Zoom"></button>
        <div class="pswp__counter"></div>
      </div>
    </div>
  </div>
</div>

<PhotoSwipeInit />
